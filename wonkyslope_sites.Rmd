---
title: "Sites with wonky slope/pvals"
output: html_document
---

For two stations the TRange trend analysis returned slopes of 0 with significant p-values. This is an unusual result. I used this script to visualize the regressions and get a sense of the point distribution. 
More than half of the TRange values across all obs at these stations were '0', due to incomplete profiles and med = max depth & max depth = .3 Removing incomplete profiles resolved the problem, both by ensuring data quality and by eliminating the issue of 0s/ties that result in mblm function giving a warning about being unable to calculate precise p-values.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)

trendSites.df <- openxlsx::read.xlsx("data_original.xlsx", sheet = 2)
allData.df <- openxlsx::read.xlsx("data_original.xlsx", sheet = 3)

# Convert `date` column from Excel encoded date to a more legible date format. Otherwise date shows as numeric value, e.g. '44230'.
    allData.df$Date <- allData.df$Date * 86400      # 86400 = seconds in a day.
    allData.df$Date <- as.POSIXct(allData.df$Date, origin = "1899-12-30", tz = "UTC")

# a surface temperature (Tmax) of 2.8 C in August
# 13774 	6ACNR000.00 	8/28/1990 	0.3 	NA 	NA 	NA 	NA

which(grepl("13774", allData.df$X1))
allData.df[13770, (5:8)] <- NA

```

```{r `subset and filter data`, echo=FALSE, warning= FALSE}
# filter for rows corresponding to the 41 stations
station_IDS <- trendSites.df$FDT_STA_ID
subset.df <- allData.df %>%
  mutate(MonthNum = lubridate::month(Date),
         Year = lubridate::year(Date)) %>%  
  filter(FDT_STA_ID %in% station_IDS) %>%
  filter(MonthNum %in% 5:10) %>%
  filter(MaxDepth.x >= .8*MedDepth)

# Paul discovered 5 sites that slipped the filter despite having incomplete profiles (median = .3, but only surface taken)
# 2-XDD000.40, 4AROA192.55, 5ASRN000.66, 6ACNR000.00, and 6APNR008.1
incomplete_profiles <- c("2-XDD000.40", "4AROA192.55", "5ASRN000.66", "6ACNR000.00", "6APNR008.15")
subset.df <- subset.df %>%
  filter(!FDT_STA_ID %in% incomplete_profiles)

monthly_TRange <- subset.df %>%
  group_by(FDT_STA_ID, MonthNum) %>%
  summarize(Mean = mean(TRange, na.rm = TRUE),
            Min = min(TRange, na.rm = TRUE),
            Max = max(TRange, na.rm = TRUE),
            Nobs = n(),
            .groups = 'drop') %>%
  mutate(Month = month.name[MonthNum])

cols_to_keep <- colnames(subset.df)

countPerGroup <- subset.df %>%
  group_by(FDT_STA_ID, MonthNum) %>%
  summarise(Nobs = n()) %>%
  mutate(key = paste(FDT_STA_ID, MonthNum, sep="_"))

insufficient_Nobs <- countPerGroup %>%
  filter(Nobs < 10)

insufficient_Nobs <- insufficient_Nobs$key

df.TRange <- subset.df %>%
  left_join(monthly_TRange, by = c("FDT_STA_ID", "MonthNum")) %>%
  select(cols_to_keep, Mean) 

# apply filter to exclude month-stations with < 10 Nobs from visualization
monthly_TRange <- monthly_TRange %>%
  mutate(key = paste(FDT_STA_ID, MonthNum, sep="_")) %>%
  filter(!key %in% insufficient_Nobs)

```

```{r `fit regressions for each month-station`, echo=FALSE, warning= FALSE}
# fit a linear regression for TRange vs. year by month-station using the mblm function (median based linear model) as this is thought to be less sensitive to outliers.

# install.packages("mblm")
library(mblm)

#Usage
#mblm(formula, dataframe, repeated = TRUE)
  #Arguments
    #formula A formula of type y ~ x (only linear models are accepted)
    #dataframe Optional dataframe
    #repeated If set to true, model is computed using repeated medians. If false, a single median estimators are calculated

# remove NA values -- mblm() does not handle NA as lm() does
df.TRange <- df.TRange %>%
  filter(!is.na(TRange))

# create list to store regression results
modelSummaries <- list()

for (station_id in unique(df.TRange$FDT_STA_ID)) {
  for (month_num in 5:10) {
    
    month_station <- df.TRange %>%
      filter(FDT_STA_ID == station_id & MonthNum == month_num)

      model <- mblm(TRange ~ Year, data = month_station)
      mod.sum <- summary.mblm(model)
      
      # store results
      modelSummaries[[paste(station_id, month_num, sep = "_")]] <- list(
        slope = mod.sum$coefficients[2,1],
        MAD = mod.sum$coefficients["Year", "MAD"] ,
        pvalue = mod.sum$coefficients["Year", 4]
        )
  }
}

# mblm does not return a standard error. Instead, summary.mblm can be used to extract the MAD or Median Absolute Deviation." It's a robust measure of variability that is less sensitive to outliers than the standard deviation, which is commonly used in traditional statistical analyses. 

```


```{r `add reg stats to summary df`, echo=FALSE, warning= FALSE}
# create station-month key
monthly_TRange <- monthly_TRange %>%
  mutate( key = paste(FDT_STA_ID, MonthNum, sep="_"),
          model_slope = NA,
          model_MAD = NA,
          model_pval = NA)

for (i in 1:nrow(monthly_TRange)) {
  key = monthly_TRange$key[i]
  
  monthly_TRange$model_slope[i] <-  modelSummaries[[key]]$slope
   monthly_TRange$model_MAD[i] <-  modelSummaries[[key]]$MAD
    monthly_TRange$model_pval[i] <-  modelSummaries[[key]]$pvalue
  
}


monthly_TRange %>%
  select(-key) -> TRange_final

```

```{r, echo = FALSE}
# check Trange for 4AROA038.49, 9-NEW098.32, " as these came back 
#having slopes = 0.000, but with sig p values, which does not make sense"

wonky <- c("4AROA038.49", "9-NEW098.32")

monthly_TRange %>%
  filter(FDT_STA_ID %in% wonky) -> pp

subset.df %>%
  filter(FDT_STA_ID %in% wonky) -> xx

xx %>%
  mutate(key = paste(FDT_STA_ID, MonthNum, sep="_")) %>%
  group_by(key) %>%
  summarize(var = var(TRange, na.rm = TRUE),
            sd = sd(TRange, na.rm = TRUE)) -> yy

yy %>%
  left_join(pp, by = "key") -> zz

```

```{r, echo = FALSE, warning = FALSE}
# examine trend results for 4AR0A038.49

subset.df %>%
  filter(FDT_STA_ID == "4AROA038.49") %>%
  mutate(Month = month.name[lubridate::month(Date)]) %>%
  group_by(MonthNum) -> sta_4A

# calculate mblm for each month and store intercepts and slopes
mblm_fits <- sta_4A %>%
  group_by(Month) %>%
  do(model = mblm::mblm(TRange ~ Year, data = .)) %>%
  summarise(intercept = coef(model)[1], 
            slope = coef(model)[2], 
            "p val" = mblm::summary.mblm(model)$coefficients[2,4], 
            Month = first(Month)) %>%
  mutate(Month = factor(Month))

# create df to use for plotting
plottingData <- merge(sta_4A, mblm_fits, by = "Month")

plottingData <- plottingData %>%
  mutate(Month = factor(Month, levels = c("May", "June", "July", "August", "September", "October")))

ggplot(data = plottingData) +
  geom_point(aes(x = Year, y = TRange), alpha = .6, size = 2) +
  geom_abline(aes(intercept = intercept, slope = slope), color = "blue", linewidth = 1) +
  facet_wrap(~factor(Month), scales = "free_y") +
  labs(title = "Temperature Range vs. Year, Station 4AROA038.49",
       x = "Year",
       y = "TRange Trend (C/y)") +  
  scale_shape_manual(values = c(1, 16)) +
  theme_minimal() + 
  theme(legend.position = "top",
        panel.border = element_rect(colour = "black", fill=NA, size=.5),
        plot.title = element_text(size = 16),  # Adjusts plot title size
        axis.title = element_text(size = 14),  # Adjusts axis titles size
        axis.text = element_text(size = 11.5),  # Adjusts axis text size
        legend.text = element_text(size = 9.5),  # Adjusts legend text size
        legend.title = element_text(size = 10.5),  # Adjusts legend title size
        strip.text = element_text(size = 12))  # Adjusts facet 
```


```{r, echo = FALSE, warning= FALSE}
# examine trend results for "9-NEW098.32"

subset.df %>%
  filter(FDT_STA_ID == "9-NEW098.32") %>%
  mutate(Month = month.name[lubridate::month(Date)]) %>%
  group_by(MonthNum) -> sta_9NEW

# calculate mblm for each month and store intercepts and slopes
mblm_fits <- sta_9NEW %>%
  group_by(Month) %>%
  do(model = mblm::mblm(TRange ~ Year, data = .)) %>%
  summarise(intercept = coef(model)[1], 
            slope = coef(model)[2], 
            "p val" = mblm::summary.mblm(model)$coefficients[2,4], 
            Month = first(Month)) %>%
  mutate(Month = factor(Month))

# create df to use for plotting
plottingData <- merge(sta_9NEW, mblm_fits, by = "Month")

plottingData <- plottingData %>%
  mutate(Month = factor(Month, levels = c("May", "June", "July", "August", "September", "October")))

ggplot(data = plottingData) +
  geom_point(aes(x = Year, y = TRange), alpha = .6, size = 2) +
  geom_abline(aes(intercept = intercept, slope = slope), color = "blue", linewidth = 1) +
  facet_wrap(~factor(Month), scales = "free_y") +
  labs(title = "Temperature Range vs. Year, Station 9-NEW098.32",
       x = "Year",
       y = "TRange Trend (C/y)") +  
  scale_shape_manual(values = c(1, 16)) +
  theme_minimal() + 
  theme(legend.position = "top",
        panel.border = element_rect(colour = "black", fill=NA, size=.5),
        plot.title = element_text(size = 16),  # Adjusts plot title size
        axis.title = element_text(size = 14),  # Adjusts axis titles size
        axis.text = element_text(size = 11.5),  # Adjusts axis text size
        legend.text = element_text(size = 9.5),  # Adjusts legend text size
        legend.title = element_text(size = 10.5),  # Adjusts legend title size
        strip.text = element_text(size = 12)) 
```
